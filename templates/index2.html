<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Song Metadata Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    /* Base */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background: #fafafa;
      color: #111827;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 1.5rem 0;
    }

    .sidebar h1 {
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 2rem;
      color: #111827;
    }

    .nav-link {
      display: block;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      color: #374151;
      margin: 0.25rem 0.75rem;
      border-radius: 0.5rem;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .nav-link:hover {
      background: #f3f4f6;
      color: #2563eb;
    }

    .nav-link.active {
      background: #e0f2fe;
      color: #1d4ed8;
      font-weight: 600;
    }

    /* Main */
    .main {
      flex: 1;
      background: #ffffff;
      padding: 2rem;
      overflow-y: auto;
    }

    .section h2 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #111827;
    }

    /* Song Cards */
    .song-card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.25rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #f3f4f6;
      transition: transform 0.2s ease;
      position: relative;
    }

    .song-card:hover {
      transform: translateY(-3px);
    }

    .toggle-card {
      background: #f3f4f6;
      font-size: 0.75rem;
      border-radius: 0.5rem;
      padding: 4px 8px;
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }

    .toggle-card:hover {
      background: #e5e7eb;
    }

    .card-content {
      transition: max-height 0.4s ease, opacity 0.4s ease;
      overflow: hidden;
      max-height: 1000px;
    }

    .collapsed {
      max-height: 0 !important;
      opacity: 0;
      padding: 0 !important;
    }

    /* Insights Panel */
    #insights,
    #database-insights {
      background: #f9fafb;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 1rem;
      border: 1px solid #e5e7eb;
    }

    #insights h3,
    #database-insights h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
    }

    .insight-item {
      display: inline-block;
      margin: 4px;
      padding: 6px 10px;
      background: #f1f5f9;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .insight-item:hover {
      background: #e2e8f0;
    }

    /* Highlight */
    .highlight {
      border: 3px solid #f59e0b;
      box-shadow: 0 0 8px #fbbf24;
    }

    /* Graph */
    #network {
      border-radius: 0.75rem;
      background: #fff;
      border: 1px solid #f3f4f6;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    #graph-controls {
      border-radius: 0.75rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body class="flex h-screen bg-gray-100 text-gray-800 font-sans">

  <!-- Sidebar -->
  <div class="w-64 bg-blue-100 flex flex-col">
    <h1 class="text-xl font-bold text-center text-blue-900 py-6 border-b border-blue-200">Music Data Tool</h1>
    <nav class="flex flex-col mt-4">
      <a href="#" class="nav-link active" data-section="song-input">Song Input</a>
      <a href="#" class="nav-link" data-section="graph">Graph</a>
      <a href="#" class="nav-link" data-section="database">Database</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="flex-1 p-6 overflow-y-auto bg-white">
    <!-- Song Input -->
    <div id="song-input" class="section">
      <h2 class="text-2xl font-bold mb-6">Song Input</h2>
      <form id="songForm" class="space-y-4">
        <div id="songInputs" class="space-y-3">
          <div class="bg-gray-50 p-4 rounded flex gap-4 items-center">
            <input type="text" name="artist" placeholder="Artist Name" required class="border rounded px-4 py-2 flex-1">
            <input type="text" name="title" placeholder="Song Title" required class="border rounded px-4 py-2 flex-1">
          </div>
        </div>
        <div class="flex gap-4">
          <button type="button" id="addSongBtn"
            class="bg-pink-100 text-blue-900 font-medium px-4 py-2 rounded hover:bg-pink-200">+ Add Song</button>
          <button type="submit" id="submitBtn"
            class="bg-blue-500 text-white font-semibold px-4 py-2 rounded hover:bg-blue-600">Submit</button>
        </div>
      </form>
      <div class="mt-8">
        <div class="flex justify-end gap-4 mb-4 hidden" id="toggleControlsSongInput">
          <button id="expandAllInput" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">Expand All</button>
          <button id="collapseAllInput" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">Collapse All</button>
        </div>
        <div id="results" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
        <div id="insights" class="mt-6"></div>
      </div>
    </div>

    <!-- Graph -->
    <div id="graph" class="section hidden">
      <h2 class="text-2xl font-bold mb-4">Graph Visualization</h2>

      <!-- Controls -->
      <div class="space-y-3 mb-4">
        <div class="flex flex-wrap items-center gap-4">
          <button id="graphCurrentBtn"
            class="bg-blue-500 text-white font-semibold px-4 py-2 rounded hover:bg-blue-600">Graph Current
            Input</button>
          <button id="graphDatabaseBtn"
            class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded hover:bg-gray-300">Graph Database</button>
          <button id="resetFilters" class="bg-gray-300 px-3 py-2 rounded hover:bg-gray-400">Reset Filters</button>
        </div>
        <div class="flex flex-wrap items-center gap-4">
          <label><input type="checkbox" class="filter-toggle" value="contributor" checked> Contributors</label>
          <label><input type="checkbox" class="filter-toggle" value="label" checked> Labels</label>
          <label><input type="checkbox" class="filter-toggle" value="publisher" checked> Publishers</label>
          <label><input type="checkbox" class="filter-toggle" value="genre" checked> Genres</label>
          <div class="flex items-center gap-2">
            <span>Track Pop:</span>
            <input type="range" id="trackPopularity" min="0" max="100" value="0" class="w-24">
            <span id="trackPopularityVal">0+</span>
          </div>
          <div class="flex items-center gap-2">
            <span>Artist Pop:</span>
            <input type="range" id="artistPopularity" min="0" max="100" value="0" class="w-24">
            <span id="artistPopularityVal">0+</span>
          </div>
        </div>
      </div>

      <!-- Graph + Details -->
      <div class="flex gap-6 h-[600px]">
        <div id="network" class="flex-1 border rounded shadow bg-white"></div>
        <div id="graph-controls" class="w-72 bg-gray-50 border rounded p-4 space-y-4 overflow-y-auto">
          <h3 class="font-semibold mb-2">Legend</h3>
          <div class="text-sm space-y-1">
            <div><span class="inline-block w-3 h-3 rounded-full bg-blue-300 mr-2"></span>Song</div>
            <div><span class="inline-block w-3 h-3 rounded-full bg-yellow-400 mr-2"></span>Contributor</div>
            <div><span class="inline-block w-3 h-3 rounded-full bg-orange-500 mr-2"></span>Label</div>
            <div><span class="inline-block w-3 h-3 rounded-full bg-pink-500 mr-2"></span>Publisher</div>
            <div><span class="inline-block w-3 h-3 rounded-full bg-teal-500 mr-2"></span>Genre</div>
          </div>
          <h3 class="font-semibold mb-2 mt-4">Node Details</h3>
          <div id="details-panel" class="text-sm p-2 bg-white border rounded">Select a node to view details.</div>
        </div>
      </div>
    </div>


    <!-- Database -->
    <div id="database" class="section hidden">
      <h2 class="text-2xl font-bold mb-4">Database</h2>
      <div class="flex justify-end gap-4 mb-4">
        <button id="expandAllDB" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">Expand All</button>
        <button id="collapseAllDB" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">Collapse All</button>
      </div>
      <div id="database-results" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
      <div id="database-insights" class="mt-6"></div>
    </div>
  </div>

  <script>
    let databaseData = [], network = null;
    const colors = { song: '#8ecae6', contributor: '#ffb703', label: '#fb8500', publisher: '#ff006e', genre: '#219ebc' };

    // Navigation between tabs
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(link.dataset.section).classList.remove('hidden');
        if (link.dataset.section === 'database') renderDatabase();
        if (link.dataset.section === 'graph') renderGraph(databaseData);
      });
    });

    // Add song input row
    document.getElementById('addSongBtn').addEventListener('click', () => {
      const div = document.createElement('div');
      div.className = 'bg-gray-50 p-4 rounded flex gap-4 items-center';
      div.innerHTML = `
    <input type="text" placeholder="Artist Name" class="border rounded px-4 py-2 flex-1">
    <input type="text" placeholder="Song Title" class="border rounded px-4 py-2 flex-1">
    <button type="button" class="remove-song bg-red-100 text-red-600 px-3 py-1 rounded">Remove</button>
  `;
      div.querySelector('.remove-song').addEventListener('click', () => div.remove());
      document.getElementById('songInputs').appendChild(div);
    });

    // Fetch database.json
    async function fetchDatabase() {
      if (databaseData.length) return;
      const res = await fetch('../database.json'); // Adjust path if needed
      databaseData = await res.json();
    }

    // Submit form → render data
    document.getElementById('songForm').addEventListener('submit', async e => {
      e.preventDefault();
      await fetchDatabase();
      displayResults('results', databaseData, 'toggleControlsSongInput');
      displayInsights(databaseData, 'insights');
    });

    // Render Database tab
    async function renderDatabase() {
      await fetchDatabase();
      displayResults('database-results', databaseData);
      displayInsights(databaseData, 'database-insights');
    }

    // Display Song Cards
    function displayResults(containerId, songs, controlsId = null) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      songs.forEach(song => {
        const contributorsHTML = (song.contributors || []).map(c =>
          `<li><span class="font-semibold">${c.name}</span> ${(c.roles || []).map(r => `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded">${r}</span>`).join(' ')}</li>`
        ).join('');
        const genresHTML = (song.genres || []).map(g => `<span class="bg-teal-100 text-teal-800 text-xs px-2 py-0.5 rounded">${g}</span>`).join('');
        const publishersHTML = (song.publishers || []).map(p => `<span class="bg-pink-100 text-pink-800 text-xs px-2 py-0.5 rounded">${p}</span>`).join('');

        const card = document.createElement('div');
        card.className = 'song-card relative';
        card.setAttribute('data-song-title', song.title);
        card.innerHTML = `
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold">${song.title}</h3>
        <button class="toggle-card bg-gray-200 text-xs px-2 py-1 rounded">Collapse</button>
      </div>
      <p class="text-sm mb-2"><strong>${song.artist}</strong></p>
      <div class="card-content mt-2 space-y-3">
        <p><strong>Album:</strong> ${song.album || ''}</p>
        <p><strong>Release Year:</strong> ${song.release_year || ''}</p>
        <div><strong>Label:</strong> <span class="bg-orange-100 text-orange-800 text-xs px-2 py-0.5 rounded">${song.label || ''}</span></div>
        ${publishersHTML ? `<div class="mt-2"><strong>Publishers:</strong><div class="flex flex-wrap gap-2 mt-1">${publishersHTML}</div></div>` : ''}
        ${genresHTML ? `<div class="mt-2"><strong>Genres:</strong><div class="flex flex-wrap gap-2 mt-1">${genresHTML}</div></div>` : ''}
        <div class="mt-2"><strong>Contributors:</strong><ul class="mt-1 space-y-1">${contributorsHTML}</ul></div>
      </div>`;
        container.appendChild(card);
      });

      if (controlsId) document.getElementById(controlsId).classList.remove('hidden');

      // Collapse/Expand logic
      container.querySelectorAll('.toggle-card').forEach(btn => {
        btn.addEventListener('click', () => {
          const content = btn.closest('.song-card').querySelector('.card-content');
          content.classList.toggle('collapsed');
          btn.textContent = content.classList.contains('collapsed') ? 'Expand' : 'Collapse';
        });
      });
    }

    // Expand/Collapse All
    ['expandAllInput', 'collapseAllInput', 'expandAllDB', 'collapseAllDB'].forEach(id => {
      document.getElementById(id).addEventListener('click', () => toggleAll(id.includes('Input') ? 'results' : 'database-results', id.includes('expand')));
    });
    function toggleAll(containerId, expand) {
      document.querySelectorAll(`#${containerId} .card-content`).forEach(c => {
        c.classList.toggle('collapsed', !expand);
        const btn = c.closest('.song-card').querySelector('.toggle-card');
        btn.textContent = expand ? 'Collapse' : 'Expand';
      });
    }

    // Display Insights
    function displayInsights(songs, containerId) {
      const div = document.getElementById(containerId);
      if (!songs.length) { div.innerHTML = ''; return; }

      // Build maps for summaries and adjacency
      const contributorsMap = {}, labelsMap = {}, genresMap = {}, publishersMap = {};
      const trackPopularity = { '0-25': [], '26-50': [], '51-75': [], '76-100': [] };
      const artistPopularity = { '0-25': [], '26-50': [], '51-75': [], '76-100': [] };
      const contributorsMapJS = {};
      const adjacency = {};

      songs.forEach(song => {
        const names = (song.contributors || []).map(c => c.name);

        // Summaries
        (song.contributors || []).forEach(c => {
          contributorsMap[c.name] = (contributorsMap[c.name] || 0) + 1;
        });
        if (song.label) labelsMap[song.label] = (labelsMap[song.label] || 0) + 1;
        (song.genres || []).forEach(g => genresMap[g] = (genresMap[g] || 0) + 1);
        (song.publishers || []).forEach(p => publishersMap[p] = (publishersMap[p] || 0) + 1);

        if (song.spotify_popularity !== undefined) {
          const item = `${song.title} (${song.spotify_popularity})`;
          if (song.spotify_popularity <= 25) trackPopularity['0-25'].push(item);
          else if (song.spotify_popularity <= 50) trackPopularity['26-50'].push(item);
          else if (song.spotify_popularity <= 75) trackPopularity['51-75'].push(item);
          else trackPopularity['76-100'].push(item);
        }
        if (song.artist_popularity !== undefined) {
          const item = `${song.artist} (${song.artist_popularity})`;
          if (song.artist_popularity <= 25) artistPopularity['0-25'].push(item);
          else if (song.artist_popularity <= 50) artistPopularity['26-50'].push(item);
          else if (song.artist_popularity <= 75) artistPopularity['51-75'].push(item);
          else artistPopularity['76-100'].push(item);
        }

        // Build adjacency and contributor data
        names.forEach(a => {
          if (!adjacency[a]) adjacency[a] = new Set();
          if (!contributorsMapJS[a]) contributorsMapJS[a] = { co_contributors: new Set(), songs: [] };
          contributorsMapJS[a].songs.push(song.title);
          names.forEach(b => {
            if (a !== b) {
              adjacency[a].add(b);
              contributorsMapJS[a].co_contributors.add(b);
            }
          });
        });
      });

      // --- Clustering logic ---
      const clusters = [];
      const contributorNames = Object.keys(contributorsMapJS);
      for (let i = 0; i < contributorNames.length; i++) {
        for (let j = i + 1; j < contributorNames.length; j++) {
          const combo = [contributorNames[i], contributorNames[j]];
          const commonSongs = songs.filter(s =>
            combo.every(cn => (s.contributors || []).some(c => c.name === cn))
          );
          if (commonSongs.length >= 2) {
            const cluster = new Set(combo);
            let added = true;
            while (added) {
              added = false;
              for (const other of contributorNames) {
                if (!cluster.has(other)) {
                  const allAppear = Array.from(cluster).every(cn =>
                    songs.filter(s =>
                      (s.contributors || []).some(c => c.name === cn) &&
                      (s.contributors || []).some(c => c.name === other)
                    ).length >= 2
                  );
                  if (allAppear) {
                    cluster.add(other);
                    added = true;
                  }
                }
              }
            }
            if (!clusters.some(c => Array.from(cluster).every(x => c.has(x)))) clusters.push(cluster);
          }
        }
      }

      // --- Linking logic (corrected) ---
      const connectors = [];
      for (const contributor in contributorsMapJS) {
        const data = contributorsMapJS[contributor];
        const coContributors = Array.from(data.co_contributors);
        const uniqueLinks = [];
        for (let i = 0; i < coContributors.length; i++) {
          for (let j = i + 1; j < coContributors.length; j++) {
            const a = coContributors[i];
            const b = coContributors[j];
            if (!adjacency[a].has(b)) {
              uniqueLinks.push([a, b]);
            }
          }
        }
        if (uniqueLinks.length > 0) {
          const linkedNames = Array.from(new Set(uniqueLinks.flat()));
          connectors.push({
            name: contributor,
            linked_contributors: linkedNames,
            songs: data.songs
          });
        }
      }

      // --- Build Insights UI ---
      div.innerHTML = `
    <h3 class="text-xl font-semibold mb-2">Derived Insights</h3>
    <p class="text-sm text-gray-500 mb-2">Click an insight to highlight applicable songs</p>
    <p class="mb-3 text-gray-700">Songs: ${songs.length}, Unique Contributors: ${Object.keys(contributorsMap).length}, Unique Labels: ${Object.keys(labelsMap).length}</p>
  `;

      if (clusters.length) {
        div.innerHTML += `<h4 class="font-semibold mt-3">Clustering <span class="text-gray-500 text-xs">Contributors who worked together on multiple songs</span></h4>`;
        clusters.forEach(cluster => {
          const names = Array.from(cluster);
          const clusterSongs = songs.filter(s =>
            names.every(n => (s.contributors || []).some(c => c.name === n))
          ).map(s => s.title);
          div.innerHTML += `
        <span class="insight-item" data-songs="${clusterSongs.join(',')}">
          ${names.join(', ')} worked on ${clusterSongs.length} songs together
        </span>
      `;
        });
      }

      if (connectors.length) {
        div.innerHTML += `
      <h4 class="font-semibold mt-3">Linking 
        <span class="text-gray-500 text-xs">
          A contributor who connects others that don’t otherwise share a song
        </span>
      </h4>
    `;
        connectors.forEach(conn => {
          const linkedNamesPreview = conn.linked_contributors.slice(0, 3).join(', ');
          div.innerHTML += `
        <span class="insight-item" data-songs="${conn.songs.join(',')}">
          ${conn.name} links ${linkedNamesPreview}
        </span>
      `;
        });
      }

      div.innerHTML += `
    <h4 class="font-semibold mt-3">Shared Contributors</h4>
    ${Object.entries(contributorsMap).filter(([k, v]) => v > 1).map(([k, v]) => `
      <span class="insight-item" data-type="contributor" data-value="${k}">${k} (${v})</span>
    `).join('')}
    <h4 class="font-semibold mt-3">Shared Labels</h4>
    ${Object.entries(labelsMap).map(([k, v]) => `
      <span class="insight-item" data-type="label" data-value="${k}">${k} (${v})</span>
    `).join('')}
    <h4 class="font-semibold mt-3">Shared Genres</h4>
    ${Object.entries(genresMap).map(([k, v]) => `
      <span class="insight-item" data-type="genre" data-value="${k}">${k} (${v})</span>
    `).join('')}
    <h4 class="font-semibold mt-4">Popularity Distribution</h4>
    <p class="mt-2"><strong>Track Popularity:</strong></p>
    ${Object.entries(trackPopularity).map(([range, list]) =>
        list.length ? `<p><span class="${getColor(range)} px-2 py-0.5 rounded">${range}</span>: ${list.join(', ')}</p>` : ''
      ).join('')}
    ${Object.values(artistPopularity).some(arr => arr.length) ? `
      <p class="mt-2"><strong>Artist Popularity:</strong></p>
      ${Object.entries(artistPopularity).map(([range, list]) =>
        list.length ? `<p><span class="${getColor(range)} px-2 py-0.5 rounded">${range}</span>: ${list.join(', ')}</p>` : ''
      ).join('')}
    ` : ''}
    <h4 class="font-semibold mt-4">Top Entities</h4>
    <p>Contributor: ${getTop(contributorsMap)}, Label: ${getTop(labelsMap)}, Genre: ${getTop(genresMap)}</p>
  `;

      // Highlight logic for clustering/linking and shared items
      div.querySelectorAll('.insight-item').forEach(item => {
        item.addEventListener('click', () => {
          const songsAttr = item.getAttribute('data-songs');
          if (songsAttr) {
            const targetSongs = songsAttr.split(',');
            document.querySelectorAll('.song-card').forEach(card => {
              const title = card.querySelector('h3').textContent;
              card.classList.toggle('highlight', targetSongs.includes(title));
            });
          } else {
            const value = item.dataset.value, type = item.dataset.type;
            document.querySelectorAll('.song-card').forEach(card => {
              const title = card.querySelector('h3').textContent;
              const matches = (() => {
                if (type === 'contributor') return songs.some(s => s.title === title && s.contributors.some(c => c.name === value));
                if (type === 'label') return songs.some(s => s.title === title && s.label === value);
                if (type === 'genre') return songs.some(s => s.title === title && (s.genres || []).includes(value));
                return false;
              })();
              card.classList.toggle('highlight', matches);
            });
          }
        });
      });
    }

    function getColor(range) {
      return range === '0-25' ? 'bg-orange-100 text-orange-800' :
        range === '26-50' ? 'bg-yellow-100 text-yellow-800' :
          range === '51-75' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
    }
    function getTop(map) {
      return Object.entries(map).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
    }


    // Render Graph
    document.getElementById('graphCurrentBtn').addEventListener('click', () => {
      if (currentData && currentData.songs) renderGraph(currentData.songs);
    });
    document.getElementById('graphDatabaseBtn').addEventListener('click', async () => {
      if (!databaseData) await loadDatabase();
      if (databaseData) renderGraph(databaseData);
    });
    document.getElementById('resetFilters').addEventListener('click', () => {
      document.querySelectorAll('.filter-toggle').forEach(cb => cb.checked = true);
      document.getElementById('trackPopularity').value = 0;
      document.getElementById('artistPopularity').value = 0;
      document.getElementById('trackPopularityVal').textContent = '0+';
      document.getElementById('artistPopularityVal').textContent = '0+';
      applyGraphFilters();
    });

    document.getElementById('trackPopularity').addEventListener('input', e => {
      document.getElementById('trackPopularityVal').textContent = `${e.target.value}+`;
      applyGraphFilters();
    });
    document.getElementById('artistPopularity').addEventListener('input', e => {
      document.getElementById('artistPopularityVal').textContent = `${e.target.value}+`;
      applyGraphFilters();
    });
    document.querySelectorAll('.filter-toggle').forEach(cb => cb.addEventListener('change', applyGraphFilters));

    function renderGraph(songs) {
      const container = document.getElementById('network');
      const nodes = [];
      const edges = [];
      const addedNodes = new Set();

      songs.forEach(song => {
        const songId = `song-${song.title}`;
        if (!addedNodes.has(songId)) {
          nodes.push({ id: songId, label: song.title, type: 'song', color: colors.song, trackPopularity: song.spotify_popularity || 0, artistPopularity: song.artist_popularity || 0 });
          addedNodes.add(songId);
        }
        (song.contributors || []).forEach(c => {
          const cId = `contributor-${c.name}`;
          if (!addedNodes.has(cId)) {
            nodes.push({ id: cId, label: c.name, type: 'contributor', color: colors.contributor });
            addedNodes.add(cId);
          }
          edges.push({ from: songId, to: cId });
        });
        if (song.label) {
          const lId = `label-${song.label}`;
          if (!addedNodes.has(lId)) {
            nodes.push({ id: lId, label: song.label, type: 'label', color: colors.label });
            addedNodes.add(lId);
          }
          edges.push({ from: songId, to: lId });
        }
        (song.publishers || []).forEach(pub => {
          const pId = `publisher-${pub}`;
          if (!addedNodes.has(pId)) {
            nodes.push({ id: pId, label: pub, type: 'publisher', color: colors.publisher });
            addedNodes.add(pId);
          }
          edges.push({ from: songId, to: pId });
        });
        (song.genres || []).forEach(g => {
          const gId = `genre-${g}`;
          if (!addedNodes.has(gId)) {
            nodes.push({ id: gId, label: g, type: 'genre', color: colors.genre });
            addedNodes.add(gId);
          }
          edges.push({ from: songId, to: gId });
        });
      });

      const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
      const options = {
        physics: { enabled: true, stabilization: true },
        nodes: { shape: 'dot', size: 18, font: { size: 14 } },
        edges: { smooth: true }
      };

      network = new vis.Network(container, data, options);

      // Store original colors for reset
      allNodes = {};
      data.nodes.forEach(node => { allNodes[node.id] = { ...node }; });

      // Highlight + Node Details
      network.on('click', params => {
        if (params.nodes.length === 0) {
          resetGraphHighlight();
          document.getElementById('details-panel').innerHTML = `Select a node to view details.`;
          return;
        }
        const clickedNodeId = params.nodes[0];
        highlightNode(clickedNodeId, data);
        showNodeDetails(clickedNodeId, songs);
      });

      applyGraphFilters();
    }

    function highlightNode(nodeId, data) {
      const connectedNodes = network.getConnectedNodes(nodeId);
      const allNodeIds = data.nodes.getIds();

      allNodeIds.forEach(id => {
        if (id === nodeId || connectedNodes.includes(id)) {
          data.nodes.update({ id: id, color: '#ec4899' }); // pink highlight
        } else {
          data.nodes.update({ id: id, color: { background: allNodes[id].color, opacity: 0.2 } });
        }
      });
      highlightActive = true;
    }

    function resetGraphHighlight() {
      if (!network) return;
      const dataNodes = network.body.data.nodes;
      Object.keys(allNodes).forEach(id => {
        dataNodes.update({ id: id, color: allNodes[id].color });
      });
      highlightActive = false;
    }

    function applyGraphFilters() {
      if (!network) return;
      const trackMin = parseInt(document.getElementById('trackPopularity').value);
      const artistMin = parseInt(document.getElementById('artistPopularity').value);
      const activeTypes = Array.from(document.querySelectorAll('.filter-toggle:checked')).map(cb => cb.value);

      const dataNodes = network.body.data.nodes;
      const visibleSongs = new Set();

      // First pass: filter songs by popularity
      dataNodes.forEach(node => {
        if (node.type === 'song') {
          const hide = (node.trackPopularity || 0) < trackMin || (node.artistPopularity || 0) < artistMin;
          dataNodes.update({ id: node.id, hidden: hide });
          if (!hide) visibleSongs.add(node.id);
        }
      });

      // Second pass: handle non-song nodes
      dataNodes.forEach(node => {
        if (node.type !== 'song') {
          let hide = false;
          if (!activeTypes.includes(node.type)) {
            hide = true;
          } else {
            // Check if connected to at least one visible song
            const connected = network.getConnectedNodes(node.id);
            const hasVisibleSong = connected.some(id => visibleSongs.has(id));
            if (!hasVisibleSong) hide = true;
          }
          dataNodes.update({ id: node.id, hidden: hide });
        }
      });
    }


    function showNodeDetails(nodeId, songs) {
      const panel = document.getElementById('details-panel');
      const node = allNodes[nodeId];
      let html = `<h4 class="font-bold mb-2">${node.label}</h4>`;

      if (node.type === 'song') {
        const song = songs.find(s => `song-${s.title}` === nodeId);
        html += `
      <p><strong>Artist:</strong> ${song.artist}</p>
      <p><strong>Album:</strong> ${song.album || ''}</p>
      <p><strong>Label:</strong> ${song.label || ''}</p>
      <p><strong>Genres:</strong> ${(song.genres || []).join(', ')}</p>
      <p><strong>Track Popularity:</strong> ${song.spotify_popularity || 'N/A'}</p>
      <p><strong>Artist Popularity:</strong> ${song.artist_popularity || 'N/A'}</p>
    `;
      } else if (node.type === 'contributor') {
        const contributorSongs = songs.filter(s => (s.contributors || []).some(c => c.name === node.label));
        html += `<p><strong>Songs:</strong></p><ul>`;
        contributorSongs.forEach(s => {
          const roles = (s.contributors.find(c => c.name === node.label)?.roles || []).join(', ');
          html += `<li>${s.title} (${roles})</li>`;
        });
        html += `</ul>`;
      } else if (['label', 'publisher', 'genre'].includes(node.type)) {
        const relatedSongs = songs.filter(s => {
          if (node.type === 'label') return s.label === node.label;
          if (node.type === 'publisher') return (s.publishers || []).includes(node.label);
          if (node.type === 'genre') return (s.genres || []).includes(node.label);
        }).map(s => s.title);
        html += `<p><strong>Related Songs:</strong> ${relatedSongs.join(', ') || 'None'}</p>`;
      }

      panel.innerHTML = html;
    }
  </script>


</body>

</html>